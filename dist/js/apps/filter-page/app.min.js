"use strict";!function(e,t){var a=function(e,a,n,r,i,o,s,l,u,c,f){var p=this,d=["locations","eventTypes","ageGroups"],g=function(){return o.moment().format()},v=function(){return o.moment().add(30,"d").format()};p.requestModel=new f;var m={zIndex:100,responsiveWidth:!0};p.eventGroups=[],p.keywords="",p.chunkSize=s.requestChunkSize,p.totalResults=0,p.isLastPage=!1,p.areDatesInvalid=!1,p.isLoading=!0,p.hasResults=!0,p.data={},p.locations=[],p.eventsTypes=[],p.ageGroups=[];var h=function(e){var t=[],a=[];return e.Locations.length?t.push("locations"):a.push("locations"),e.EventsTypes.length?t.push("eventTypes"):a.push("eventTypes"),e.AgeGroups.length?t.push("ageGroups"):a.push("ageGroups"),{activePanels:t,inActivePanels:a}};p.filterEvents=function(a,n,r){p.eventGroups=[],p.isLoading=!0,p.hasResults=!0,p.requestErrorMessage="",p.requestModel=a;var i=angular.element("#start-date")[0]._flatpickr,s=angular.element("#end-date")[0]._flatpickr;e.ready(function(){i.setDate(o.moment(a.StartDate).toDate()),s.setDate(o.moment(a.EndDate).toDate()),p.userStartDate=o.moment(a.StartDate).format("MMMM DD, YYYY"),p.userEndDate=o.moment(a.EndDate).format("MMMM DD, YYYY")}),l.get(a).then(function(e){S(e),p.hasResults=!!y(e);var i=h(a);n&&t.toggleCollapseByIds(i),r&&"function"==typeof r&&r(e)}).catch(T)};var y=function(e){return e&&Object.prototype.hasOwnProperty.call(e,"totalResults")?e.totalResults:0};p.keywordSearch=function(){var e=Object.assign({},p.requestModel);e.Keyword=p.keywords,e.Page=1,u.setQueryParams([{key:"term",val:p.keywords}])},p.filterByDate=function(){if(p.areDatesInvalid=!F(p.userStartDate,p.userEndDate),!p.areDatesInvalid){var e=Object.assign({},p.requestModel);e.StartDate=p.userStartDate,e.EndDate=p.userEndDate,e.Page=1,u.setQueryParams([{key:"startDate",val:p.userStartDate},{key:"endDate",val:p.userEndDate}])}},p.clearFilters=function(){D(),E(),u.clearQueryParams(),p.filterEvents(p.requestModel)},p.loadNextPage=function(){var e=Object.assign({},p.requestModel);e.Page+=1,p.requestModel=e,l.get(e).then(O).then(function(){n(function(){$(".event-date-bar").sticky(m)})})};var b=function(e,t){Object.prototype.hasOwnProperty.call(p.data,e)||(p.data[e]=t)};p.filterByTerms=function(e,t,a,n){var r=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],i=Object.assign({},p.requestModel);switch(t.toLowerCase()){case"locations":w(i.Locations,e,a,t,n,r);break;case"agegroups":w(i.AgeGroups,e,a,t,n,r);break;case"eventtypes":w(i.EventsTypes,e,a,t,n,r)}p.filterEvents(i)};var T=function(){p.isLoading=!1,p.requestErrorMessage="There was a problem retrieving events. Please try again later."},w=function(e,t,a,n,r,i){if(a)e.push(t);else{var o=e.indexOf(t);-1!==o&&e.splice(o,1)}i&&u.updateQueryParams([{key:n,val:r}])},D=function(){p.requestModel=new f},E=function(){p.keywords="",p.userStartDate="",p.userEndDate=""},S=function(e){p.isLastPage=P(e.totalResults),p.eventGroups=e.eventGroups,p.isLoading=!1,p.hasResults=e.eventGroups.length,p.requestErrorMessage="",n(function(){$(".event-date-bar").sticky(m)})},O=function(e){p.isLastPage=P(e.totalResults),p.eventGroups=j(p.eventGroups,e.eventGroups)},P=function(e){return p.requestModel.Page*p.chunkSize>=e},F=function(e,t){return!(!e||!t)&&o.moment(e).isSameOrBefore(t)},k=function(e,t){return!(!e||!t)&&o.moment(e).isSame(t,"day")},j=function(e,t){var a=e,n=a[a.length-1];return angular.forEach(t,function(e){k(n.date,e.date)?n.events=n.events.concat(e.events):a.push(e)}),a},C=function(e){angular.element(e.currentTarget).closest(".expando-wrapper").find("i").toggleClass("fa-plus-square").toggleClass("fa-minus-square")},q=function(){return i.search().term&&i.search().term.length?i.search().term:""};angular.element(document).on("hide.bs.collapse",".expando-wrapper .collapse",C),angular.element(document).on("show.bs.collapse",".expando-wrapper .collapse",C);var M=function(e,t){if(!t)return-1;if(Object.prototype.hasOwnProperty.call(p.data,e)){var a=p.data[e].filter(function(e){return Object.prototype.hasOwnProperty.call(e,"Name")&&e.Name.toLowerCase().trim()===t.toLowerCase().trim()});return"locations"===e?a.length?a[0].LocationId:null:a.length?a[0].Id:null}return-1},A=function(e){return 0===Object.keys(e).length&&e.constructor===Object},N=function(e){return e&&e.toLowerCase().indexOf("date")>-1},x=function(e){return e.replace(/^\w/,function(e){return e.toUpperCase()})},L=function(){var e=Object.assign({},p.requestModel),t=u.getQueryParams();if(A(t))return E(),p.requestModel;var a=q();e.Keyword=a,p.keywords=a;var n=R(t);return n&&(e.StartDate=n.startDate,e.EndDate=n.endDate),Object.keys(t).forEach(function(a){if(!N(a)){var n=t[a];u.getFiltersFromString(n).forEach(function(t){var n=M(a,t);if(n&&n>-1){var r=x(a);r.indexOf("EventTypes")>-1&&(r="EventsTypes"),e[r]=G(e[r],n)}})}}),e},G=function(e,t){var a=e?e.slice():[];return e&&e.length&&e.includes(t)?a=e.filter(function(e){return e!==t}):a.push(t),a},_=function(e,t,a){b(t,e),a&&"function"==typeof a&&a()},B=function(e,t){t&&"function"==typeof t&&t(e)},I=function(e,t){var a=void 0,n=0;d.forEach(function(r){s.remoteServiceUrls[r]?a=s.remoteServiceUrls[r]:s.serviceUrls[r]&&(a=""+s.baseUrl+s.serviceUrls[r]),c.request(a).then(function(t){return _(t,r,function(){(n+=1)===d.length&&e()})},function(e){return B(e,t)})})},R=function(e){var t=u.getQueryParamValuesByKey(e,"startDate",!0),a=u.getQueryParamValuesByKey(e,"endDate",!0);return t||a?(p.userStartDate=t,p.userEndDate=a,{startDate:t||g(),endDate:a||v()}):null},H=function(e){var t=L();p.filterEvents(t,e)},U=function(){return l.get(p.requestModel).then(S).catch(T)};a.$on("$locationChangeSuccess",function(){D(),H()}),function(){I(function(){H(!0)},U)}()};a.$inject=["$document","$scope","$timeout","$animate","$location","$window","events.CONSTANTS","dataServices.eventsService","sharedFilters.filterHelperService","metaService","RequestModel"],e.controller("EventsPageCtrl",a)}(angular.module("eventsPageApp"),bcpl.boostrapCollapseHelper),namespacer("bcpl"),bcpl.boostrapCollapseHelper=function(e){return{toggleCollapseByIds:function(t){var a=t.activePanels,n=t.inActivePanels;a.forEach(function(t){e("#"+t).collapse("show")}),n.forEach(function(t){e("#"+t).collapse("hide")})}}}(jQuery),function(){angular.module("filterPageApp",["ngAnimate"]).config(function(e){e.html5Mode({enabled:!0,requireBase:!1})})}(),function(e){var t={templates:{databases:"/js/apps/filter-page/templates/card-databases.html",locations:"/js/apps/filter-page/templates/card-locations.html"},urls:{databases:"https://testservices.bcpl.info/api/structured-content/databases",locations:"/sebin/q/r/branch-amenities.json"},filters:{tags:{types:{pickOne:"one",pickMany:"many"}}}};e.constant("CONSTANTS",t)}(angular.module("filterPageApp")),function(e){var t=function(){return function(e,t){var a=[];return angular.forEach(e,function(e){var n=0;angular.forEach(e.Tags,function(e){-1!==t.indexOf(e.Tag)&&(n+=1)}),n===t.length&&a.push(e)}),a}};t.$inject=[],e.filter("cardVisibilityFilter",t)}(angular.module("filterPageApp")),function(e){var t=function(e){return{get:function(t,a){$.ajax(e.urls.databases).done(t).fail(a)}}};t.$inject=["CONSTANTS"],e.factory("databasesService",t)}(angular.module("filterPageApp")),function(e){var t=function(e){var t=function(e,t){t("string"==typeof e?JSON.parse(e):e)};return{get:function(a,n){$.ajax(e.urls.locations).done(function(e){t(e,a)}).fail(n)}}};t.$inject=["CONSTANTS"],e.factory("locationsService",t)}(angular.module("filterPageApp")),function(e){var t=function(e,t,a){return{get:function(e,t){a.get(t+"Service").get(function(t){var a=_.sortBy(t,function(e){return e.Title});e(a)})}}};t.$inject=["$location","$window","$injector"],e.factory("cardService",t)}(angular.module("filterPageApp")),function(e){var t=function(){var e=function(e){var t=[];return angular.forEach(e,function(e){t=t.concat(e.Tags)}),t},t=function(e){return _.uniq(_.pluck(e,"Name"),function(e){return e})},a=function(e,t){var a=_.where(t,{Name:e});return _.uniq(_.sortBy(_.pluck(a,"Tag"),function(e){return e}),function(e){return e})},n=function(e,t){var a=_.findWhere(t,{Name:e});return a?a.Type:"none"};return{build:function(r){var i=[],o=e(r),s=t(o);return angular.forEach(s,function(e){i.push({name:e,tags:a(e,o),type:n(e,o)})}),i},transformAttributesToTags:function(e){var t=[];return angular.forEach(e,function(e){var a=angular.extend(e,{Tags:[]});angular.forEach(e.attributes,function(e){var t=e.split("|");3!==t.length&&console.error("The attribute was not specified, this must be fixed.");var n={Name:t[0]||"none",Tag:t[1],Type:t[2]||"Many"};a.Tags.push(n)}),t.push(a)}),t}}};e.factory("filterService",t)}(angular.module("filterPageApp")),function(e){var t=function(e,t,a,n,r,i,o,s){var l=this;l.activeFilters=[],l.allCardData={},l.isEverythingFilteredOut=!1,l.setFilter=function(e,t){g(e,t),u(),f()},l.clearFilters=function(){l.activeFilters=[],u(),f()},l.setFilterType=function(e){l.filterType=e};var u=function(){var e=document.getElementById("results-display");i.addClass(e,"fade-out"),l.items=l.allCardData.filter(d),angular.element(e).trigger("bcpl.filter.changed",{items:l.items}),bcpl.utility.windowShade.cycle(250,2e3),o(function(){i.removeClass(e,"fade-out")},250)},c="function"==typeof Event?new a.Event("bc-filter-cards-loaded"):void 0,f=function(){c?document.dispatchEvent(c):angular.element(document).trigger("bc-filter-cards-loaded")},p=function(t){if(t.length){var a=Object.prototype.hasOwnProperty.call(t[0],"Tags")?t:r.transformAttributesToTags(t);l.filters=r.build(a),l.allCardData=a,l.items=a,angular.element("#results-display").trigger("bcpl.filter.changed",{items:l.items}),f(),e.$apply()}},d=function(e){var t=0;if(!e)return!1;var a=_.pluck(e.Tags,"Tag");return angular.forEach(l.activeFilters,function(e){-1!==a.indexOf(e)&&(t+=1)}),t===l.activeFilters.length},g=function(e,t){var a=Object.prototype.hasOwnProperty.call(e,"Tag"),n=a?e.Tag:e,r=l.activeFilters.indexOf(n),i=-1===r,o=t;a&&(o=_.where(l.filters,{name:e.Name}),1===o.length&&(o=o[0]));var u=!!o.type&&o.type.toLowerCase()===s.filters.tags.types.pickOne,c=[];i&&u&&angular.forEach(o.tags,function(e){e!==n&&c.push(e)}),angular.forEach(c,function(e){-1!==l.activeFilters.indexOf(e)&&l.activeFilters.splice(l.activeFilters.indexOf(e),1)}),i?l.activeFilters.push(n):l.activeFilters.splice(r,1)},v=function(e){angular.element(e.currentTarget).closest(".expando-wrapper").find("i").toggleClass("fa-plus-square").toggleClass("fa-minus-square")};angular.element(document).on("hide.bs.collapse",".expando-wrapper .collapse",v),angular.element(document).on("show.bs.collapse",".expando-wrapper .collapse",v),t.ready(function(){l.filterType&&"string"==typeof l.filterType&&n.get(p,l.filterType)})};t.$inject=["$scope","$document","$window","cardService","filterService","$animate","$timeout","CONSTANTS"],e.controller("FilterPageCtrl",t)}(angular.module("filterPageApp")),function(e){var t=function(e,t,a,n){return{restrict:"E",scope:{filterHandler:"=",cardData:"=",activeFilters:"=",template:"="},template:"",link:function(t,r,i){a(n.templates[i.template]).then(function(a){r.append(e(a)(t))})}}};t.$inject=["$compile","$injector","$templateRequest","CONSTANTS"],e.directive("card",t)}(angular.module("filterPageApp")),function(e){var t=function(){return{scope:{tag:"=",activeFilters:"=",filterHandler:"=",filterFamily:"="},restrict:"E",templateUrl:"/js/apps/filter-page/templates/filter.html",link:function(e,t){var a=angular.element(t),n=a.find("input"),r="many"===e.filterFamily.type.trim().toLowerCase()?"checkbox":"radio";n.prop("type",r),"radio"===r&&n.prop("name",e.filterFamily.name),e.toggleFilter=function(t){e.isFilterChecked=a.has(":checked").length>0,e.filterHandler(t,e.filterFamily)}}}};e.directive("filter",t)}(angular.module("filterPageApp")),function(e){var t=function(){return{scope:{familyNameOverride:"@",isInitiallyExpanded:"@",filterHandler:"=",filterData:"=",activeFilters:"=",clearFilterFn:"="},restrict:"E",templateUrl:"/js/apps/filter-page/templates/filters.html",link:function(e){var t=function(e,t){return e.toLowerCase()===t.toLowerCase()};e.$watch("filterData",function(){e.filterFamilies=e.filterData?e.filterData.map(a):e.filterFamilies,e.filterFamilies&&e.filterFamilies.length&&e.filterFamilies.forEach(function(a){var n=a&&Object.hasOwnProperty.call(a,"tags")&&a.tags.length,r=n?a.tags:[],i=!1;e.activeFilters.forEach(function(e){i||(i=!!r.filter(function(a){return t(a,e)}).length)}),a.isFilterActive=i})});var a=function(t){var a=t;return a.name="none"===a.name?e.familyNameOverride:a.name,a&&(a.filterId=a.name.replace(/[^\w]/g,"-")),a}}}};e.directive("filters",t)}(angular.module("filterPageApp")),function(e){var t=function(){return{scope:{filterHandler:"=",tagData:"=",activeFilters:"="},restrict:"E",templateUrl:"/js/apps/filter-page/templates/tag.html",link:function(e){e.toggleFilter=function(t){var a=e.tagData.Tags.filter(function(e){return e.Tag===t.Tag});a.length&&e.filterHandler(t,a[0])}}}};e.directive("tag",t)}(angular.module("filterPageApp"));