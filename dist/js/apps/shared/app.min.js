"use strict";!function(e,t){var n=function(e,n,r,a,s,o,u,i,c,l,f){var p=this,d=["locations","eventTypes","ageGroups"],v=function(){return o.moment().format()},g=function(){return o.moment().add(30,"d").format()};p.requestModel=new f;var h={zIndex:100,responsiveWidth:!0};p.eventGroups=[],p.keywords="",p.chunkSize=u.requestChunkSize,p.totalResults=0,p.isLastPage=!1,p.areDatesInvalid=!1,p.isLoading=!0,p.hasResults=!0,p.data={},p.locations=[],p.eventsTypes=[],p.ageGroups=[];var m=function(e){var t=[],n=[];return e.Locations.length?t.push("locations"):n.push("locations"),e.EventsTypes.length?t.push("eventTypes"):n.push("eventTypes"),e.AgeGroups.length?t.push("ageGroups"):n.push("ageGroups"),{activePanels:t,inActivePanels:n}};p.filterEvents=function(n,r,a){p.eventGroups=[],p.isLoading=!0,p.hasResults=!0,p.requestErrorMessage="",p.requestModel=n;var s=angular.element("#start-date")[0]._flatpickr,u=angular.element("#end-date")[0]._flatpickr;e.ready(function(){s.setDate(o.moment(n.StartDate).toDate()),u.setDate(o.moment(n.EndDate).toDate()),p.userStartDate=o.moment(n.StartDate).format("MMMM DD, YYYY"),p.userEndDate=o.moment(n.EndDate).format("MMMM DD, YYYY")}),i.get(n).then(function(e){b(e),p.hasResults=!!y(e);var s=m(n);r&&t.toggleCollapseByIds(s),a&&"function"==typeof a&&a(e)}).catch(w)};var y=function(e){return e&&Object.prototype.hasOwnProperty.call(e,"totalResults")?e.totalResults:0};p.keywordSearch=function(){var e=Object.assign({},p.requestModel);e.Keyword=p.keywords,e.Page=1,c.setQueryParams([{key:"term",val:p.keywords}])},p.filterByDate=function(){if(p.areDatesInvalid=!q(p.userStartDate,p.userEndDate),!p.areDatesInvalid){var e=Object.assign({},p.requestModel);e.StartDate=p.userStartDate,e.EndDate=p.userEndDate,e.Page=1,c.setQueryParams([{key:"startDate",val:p.userStartDate},{key:"endDate",val:p.userEndDate}])}},p.clearFilters=function(){P(),S(),c.clearQueryParams(),p.filterEvents(p.requestModel)},p.loadNextPage=function(){var e=Object.assign({},p.requestModel);e.Page+=1,p.requestModel=e,i.get(e).then(M).then(function(){r(function(){$(".event-date-bar").sticky(h)})})};var D=function(e,t){Object.prototype.hasOwnProperty.call(p.data,e)||(p.data[e]=t)};p.filterByTerms=function(e,t,n,r){var a=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],s=Object.assign({},p.requestModel);switch(t.toLowerCase()){case"locations":E(s.Locations,e,n,t,r,a);break;case"agegroups":E(s.AgeGroups,e,n,t,r,a);break;case"eventtypes":E(s.EventsTypes,e,n,t,r,a)}p.filterEvents(s)};var w=function(){p.isLoading=!1,p.requestErrorMessage="There was a problem retrieving events. Please try again later."},E=function(e,t,n,r,a,s){if(n)e.push(t);else{var o=e.indexOf(t);-1!==o&&e.splice(o,1)}s&&c.updateQueryParams([{key:r,val:a}])},P=function(){p.requestModel=new f},S=function(){p.keywords="",p.userStartDate="",p.userEndDate=""},b=function(e){p.isLastPage=k(e.totalResults),p.eventGroups=e.eventGroups,p.isLoading=!1,p.hasResults=e.eventGroups.length,p.requestErrorMessage="",r(function(){$(".event-date-bar").sticky(h)})},M=function(e){p.isLastPage=k(e.totalResults),p.eventGroups=C(p.eventGroups,e.eventGroups)},k=function(e){return p.requestModel.Page*p.chunkSize>=e},q=function(e,t){return!(!e||!t)&&o.moment(e).isSameOrBefore(t)},O=function(e,t){return!(!e||!t)&&o.moment(e).isSame(t,"day")},C=function(e,t){var n=e,r=n[n.length-1];return angular.forEach(t,function(e){O(r.date,e.date)?r.events=r.events.concat(e.events):n.push(e)}),n},j=function(e){angular.element(e.currentTarget).closest(".expando-wrapper").find("i").toggleClass("fa-plus-square").toggleClass("fa-minus-square")},G=function(){return s.search().term&&s.search().term.length?s.search().term:""};angular.element(document).on("hide.bs.collapse",".expando-wrapper .collapse",j),angular.element(document).on("show.bs.collapse",".expando-wrapper .collapse",j);var L=function(e,t){if(!t)return-1;if(Object.prototype.hasOwnProperty.call(p.data,e)){var n=p.data[e].filter(function(e){return Object.prototype.hasOwnProperty.call(e,"Name")&&e.Name.toLowerCase().trim()===t.toLowerCase().trim()});return"locations"===e?n.length?n[0].LocationId:null:n.length?n[0].Id:null}return-1},T=function(e){return 0===Object.keys(e).length&&e.constructor===Object},R=function(e){return e&&e.toLowerCase().indexOf("date")>-1},x=function(e){return e.replace(/^\w/,function(e){return e.toUpperCase()})},I=function(){var e=Object.assign({},p.requestModel),t=c.getQueryParams();if(T(t))return S(),p.requestModel;var n=G();e.Keyword=n,p.keywords=n;var r=U(t);return r&&(e.StartDate=r.startDate,e.EndDate=r.endDate),Object.keys(t).forEach(function(n){if(!R(n)){var r=t[n];c.getFiltersFromString(r).forEach(function(t){var r=L(n,t);if(r&&r>-1){var a=x(n);a.indexOf("EventTypes")>-1&&(a="EventsTypes"),e[a]=Q(e[a],r)}})}}),e},Q=function(e,t){var n=e?e.slice():[];return e&&e.length&&e.includes(t)?n=e.filter(function(e){return e!==t}):n.push(t),n},Y=function(e,t,n){D(t,e),n&&"function"==typeof n&&n()},B=function(e,t){t&&"function"==typeof t&&t(e)},A=function(e,t){var n=void 0,r=0;d.forEach(function(a){u.remoteServiceUrls[a]?n=u.remoteServiceUrls[a]:u.serviceUrls[a]&&(n=""+u.baseUrl+u.serviceUrls[a]),l.request(n).then(function(t){return Y(t,a,function(){(r+=1)===d.length&&e()})},function(e){return B(e,t)})})},U=function(e){var t=c.getQueryParamValuesByKey(e,"startDate",!0),n=c.getQueryParamValuesByKey(e,"endDate",!0);return t||n?(p.userStartDate=t,p.userEndDate=n,{startDate:t||v(),endDate:n||g()}):null},N=function(e){var t=I();p.filterEvents(t,e)},z=function(){return i.get(p.requestModel).then(b).catch(w)};n.$on("$locationChangeSuccess",function(){P(),N()}),function(){A(function(){N(!0)},z)}()};n.$inject=["$document","$scope","$timeout","$animate","$location","$window","events.CONSTANTS","dataServices.eventsService","sharedFilters.filterHelperService","metaService","RequestModel"],e.controller("EventsPageCtrl",n)}(angular.module("eventsPageApp"),bcpl.boostrapCollapseHelper),namespacer("bcpl"),bcpl.boostrapCollapseHelper=function(e){return{toggleCollapseByIds:function(t){var n=t.activePanels,r=t.inActivePanels;n.forEach(function(t){e("#"+t).collapse("show")}),r.forEach(function(t){e("#"+t).collapse("hide")})}}}(jQuery);